<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Link Rút Gọn</title>
<link rel="icon" type="image/png" href="./img/logo.png" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root{--bg:#0f1720;--card:#111318;--panel:#16181b;--accent:#1976d2;--accent-2:#66b3ff;--muted:#9aa6bf;--input-bg:#2b2b2b}
html,body{height:100%;margin:0;background:var(--bg);color:#e6eef8;font-family:Inter,Arial,Helvetica,sans-serif}

/* --- Login Styles --- */
#login-container{display:flex;align-items:center;justify-content:center;height:100%}
.login-box{background:var(--panel);padding:2.5rem 2rem;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.6);text-align:center;width:100%;max-width:360px}
.login-box h1{margin-top:0;margin-bottom:1.5rem;font-size:22px}
.login-box .input{display:block;width:100%;margin-bottom:1rem;box-sizing:border-box;font-size:16px}
.login-box .btn{width:100%;font-size:16px;padding:12px}
#loginError{color:#ffcdd2;min-height:20px;margin-top:1rem;font-size:16px}

/* --- Main App Styles --- */
.wrap{max-width:1100px;margin:28px auto;padding:18px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);box-shadow:0 6px 18px rgba(2,6,23,0.6)}
header{display:flex;gap:12px;align-items:center;margin-bottom:12px}
.logo{width:42px;height:42px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:700}
h1{font-size:22px;margin:0}
.top-row{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap}
.controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.file-label{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;border:1px solid rgba(255,255,255,0.04)}
.file-label:hover{background:var(--accent-2)}
#fileName{color:var(--muted);font-size:13px}
.btn{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-size: 16px;transition: background-color .2s ease, transform .2s ease;}
.btn:hover{transform: translateY(-2px);}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04)}
.btn.warn{background:#f0b429;color:#111}
.btn.danger{background:#d9534f}
.input, input[type="text"], textarea{background:var(--panel);border:1px solid rgba(255,255,255,0.03);padding:10px;border-radius:8px;color:#eaf2ff;font-family:inherit}

/* --- Create Link Section Styles --- */
.create-container {
    background: var(--panel);
    padding: 16px;
    border-radius: 12px;
    margin-top: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}
.create-form {
    display: flex;
    flex-direction: column; 
    align-items: stretch;
}

.input-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
    width: 100%;
    margin-bottom: 12px;
}

.input-row {
    display: flex;
    align-items: center;
    gap: 12px;
    background: var(--bg);
    border-radius: 10px;
    padding: 0 8px;
    border: 1px solid rgba(255,255,255,0.04);
}

.dual-input-row {
    display: flex;
    gap: 8px; /* Giữ khoảng cách đồng bộ */
}
.dual-input-row > .input-row {
    flex: 1; /* Chia đều không gian cho 2 ô input */
    min-width: 0;
}


.input-row .form-icon {
    color: var(--accent-2);
    font-size: 20px;
    padding-left: 8px;
}

.input-row .input {
    flex-grow: 1;
    border: none;
    background: transparent;
    font-size: 16px;
    padding: 12px 0;
}
.input-row .input:focus {
    outline: none;
}

.domain-prefix {
    color: var(--muted);
    font-size: 16px;
    white-space: nowrap;
}

.create-form .btn {
    width: 100%; 
    justify-content: center;
    padding: 12px 18px;
    display: flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
}
.create-form .btn .btn-icon {
    transition: transform 0.3s ease;
}
.create-form .btn:hover .btn-icon {
    transform: rotate(90deg);
}


.info-search-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 12px;
    margin-top: 24px;
}

.search-wrap{display:flex;justify-content:flex-end;flex:0 0 260px;}
.search-input{width:100%;font-size: 16px;padding:8px;border-radius:8px;background:var(--panel);border:1px solid rgba(255,255,255,0.03);color:#eaf2ff;box-sizing:border-box}

table{width:100%;border-collapse:collapse;margin-top:14px;border-radius:8px;overflow:hidden;background:transparent; table-layout: fixed;}
thead th{background:rgba(20,28,40,0.6);text-align:left;padding:12px;font-weight:600;color:var(--accent-2);font-size:16px}
tbody tr{border-bottom:1px solid rgba(255,255,255,0.03)}
td{padding:10px;vertical-align:middle;font-size:16px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;}
tbody tr:hover{background:rgba(255,255,255,0.01)}
.copy-btn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:10px;border-radius:8px;cursor:pointer;margin-right:8px;color:var(--muted); flex-shrink: 0;}

.cell-content-wrapper {
    display: flex;
    align-items: center;
    min-width: 0;
}
.link-text {
    color: #dfefff;
    text-decoration: none;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.link-short {
    font-weight: 500;
}
.title-text {
    color: var(--muted);
    font-style: italic;
}


@media (min-width: 821px) {
    .create-form {
        flex-direction: row;
        align-items: center;
        gap: 12px;
    }
    .input-group {
        flex-grow: 1;
        margin-bottom: 0;
    }
    .create-form .btn {
        width: auto;
    }
}

.action-btn{width:36px;height:36px;border-radius:8px;border:none;cursor:pointer;color:#0a0a0a}
.action-edit{background:#f7b955}
.action-save{background:var(--accent-2);color:#0a0a0a}
.action-del{background:#e05b5b}
.table-edit-input{background:var(--input-bg);color:#fff;border:1px solid #4da3ff;border-radius:6px;padding:6px 10px;width:95%;box-sizing:border-box}
.pagination{display:flex;gap:6px;justify-content:center;margin-top:12px}
.pg-btn{background:rgba(255,255,255,0.03);border:none;color:var(--muted);padding:6px 10px;border-radius:8px;cursor:pointer}
.pg-btn.active{background:var(--accent);color:#fff;font-size: 15px;}
@media (max-width:820px){.create-form{flex-direction:column;align-items:stretch;gap:8px}.create-form .btn{width:100%; justify-content: center;}.search-wrap{justify-content:flex-start;flex-basis:100%}.search-input{width:100%}
/* *** START: DÒNG LỆNH ĐƯỢC THÊM ĐỂ SỬA LỖI *** */
.dual-input-row{flex-direction: column;}
/* *** END: DÒNG LỆNH ĐƯỢC THÊM ĐỂ SỬA LỖI *** */
}
@media (max-width:520px){td{font-size:16px;padding:8px}.logo{width:36px;height:36px}}
.popup-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:1000;opacity:0;transition:opacity .25s ease}
.popup-overlay.show{display:flex;opacity:1}
.popup-box{background:var(--panel);padding:20px;border-radius:12px;max-width:90%;box-shadow:0 6px 20px rgba(0,0,0,0.6);animation:popupFade .25s ease forwards}
@keyframes popupFade{from{transform:scale(.95);opacity:0}to{transform:scale(1);opacity:1}}
.data-popup{width:700px;max-width:95%}
.data-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.data-textarea{width:96%;height:260px;margin:10px 0px;resize:vertical}
.close-btn{background:transparent;border:none;color:#ccc;font-size:19px;cursor:pointer}
#importedFilesList{color:var(--muted);font-size:16px;margin-top:8px}
#deleteCandidates{white-space:pre-wrap;color:#ffd6d6;margin-top:8px}
.auth-bar{display:flex;gap:12px;align-items:center;margin:12px 0;padding:8px;background:rgba(255,255,255,0.02);border-radius:8px;justify-content:space-between}
.auth-status{color:var(--muted);font-size:16px}
</style>
</head>
<body>

  <div id="login-container">
    <div class="login-box">
      <h1><i class="fa fa-lock" style="color:var(--accent-2)"></i>&nbsp; Admin</h1>
      <input id="adminEmail" class="input" placeholder="Email" />
      <input id="adminPass" class="input" type="password" placeholder="Mật khẩu" />
      <button class="btn" id="loginBtn">Đăng nhập</button>
      <p id="loginError"></p>
    </div>
  </div>

  <div id="main-container" style="display:none;">
    <div class="wrap">
      <header>
        <div class="logo"><i class="fa fa-link" style="color:#fff"></i></div>
        <div><h1>Link Rút Gọn</h1></div>
      </header>

      <div class="auth-bar">
        <span id="authStatus" class="auth-status"></span>
        <button class="btn ghost" id="logoutBtn">Đăng xuất</button>
      </div>

      <div class="top-row">
        <div class="controls">
          <button class="btn warn" id="showDataBtn"><i class="fa fa-database"></i>&nbsp; Dữ liệu</button>
          <label class="file-label" for="importFiles"><i class="fa fa-file-import"></i>&nbsp; File (.json)</label>
          <input type="file" id="importFiles" accept=".json" multiple style="display:none">
          <label class="file-label" for="importFolder"><i class="fa fa-folder-open"></i>&nbsp; Thư mục</label>
          <input type="file" id="importFolder" webkitdirectory directory multiple style="display:none">
          <button class="btn" id="exportBtn"><i class="fa fa-file-export"></i>&nbsp; Xuất file</button>
        </div>
      </div>
       <span id="fileName">Chưa có tệp</span>

      <div class="create-container">
        <div class="create-form">
            <div class="input-group">
                <div class="input-row">
                    <i class="fa fa-link form-icon"></i>
                    <input id="originalInput" class="input" placeholder="Dán link gốc của bạn vào đây..."/>
                </div>
                <div class="dual-input-row">
                    <div class="input-row">
                        <i class="fa fa-pencil-alt form-icon" style="color: var(--muted);"></i>
                        <span id="domainPrefix" class="domain-prefix"></span>
                        <input id="customAliasInput" class="input" placeholder="...mã tùy chỉnh"/>
                    </div>
                    <div class="input-row">
                        <i class="fa fa-tag form-icon" style="color: var(--muted);"></i>
                        <input id="titleInput" class="input" placeholder="...thêm tiêu đề"/>
                    </div>
                </div>
            </div>
            <button id="createBtn" class="btn">
                <span class="btn-text">Tạo Link</span>&nbsp;<i class="fa fa-magic btn-icon"></i>
            </button>
        </div>
      </div>
      <div class="info-search-bar">
        <div id="infoLine" style="color:var(--muted);font-size:15px"></div>
        <div class="search-wrap">
          <input id="searchInput" class="search-input" placeholder="Tìm kiếm mã, link hoặc tiêu đề..." />
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:20%">Rút gọn</th>
            <th style="width:20%">Tiêu đề</th>
            <th>Link gốc</th>
            <th style="width:140px; text-align:right;">Hành động</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
      <div class="pagination" id="pagination"></div>

      <div id="importedFilesList"></div>
      <div id="deleteCandidates"></div>
    </div>
  </div>

  <div id="dataPopup" class="popup-overlay">
    <div class="popup-box data-popup">
      <div class="data-header">
        <strong>Dữ liệu (JSON)</strong>
        <div>
          <button id="copyDataBtn" class="copy-btn" title="Copy toàn bộ dữ liệu"><i class="fa fa-copy"></i></button>
          <button class="close-btn" id="closeDataPopup">&times;</button>
        </div>
      </div>
      <textarea id="dataTextarea" class="data-textarea"></textarea>
      <div style="margin-top:6px; text-align:left; color:var(--muted)">
        <small>Gợi ý: bạn có thể chỉnh JSON thủ công rồi Lưu thay đổi (sẽ ghi vào Firestore).</small>
      </div>
      <div style="margin-top:6px; text-align:right;">
        <button id="saveDataBtn" class="btn warn"><i class="fa fa-save"></i> Lưu thay đổi</button>
      </div>
    </div>
  </div>

  <div id="confirmPopup" class="popup-overlay">
    <div class="popup-box" style="max-width:320px;">
      <div style="margin-bottom:16px;font-size:20px;">Bạn có chắc muốn xóa mục này?</div>
      <div style="display:flex;gap:10px;justify-content:center;">
        <button id="confirmYes" class="btn danger">Xóa</button>
        <button id="confirmNo" class="btn ghost">Hủy</button>
      </div>
    </div>
  </div>

<script type="module">
/* Firebase + Firestore integration */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, getDoc, setDoc, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

/* ---------- CONFIG ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyAIGu_5QNMvzrObPNxHdG9kybBQtAddGsw",
  authDomain: "linkrutgon-a69c8.firebaseapp.com",
  projectId: "linkrutgon-a69c8",
  storageBucket: "linkrutgon-a69c8.firebasestorage.app",
  messagingSenderId: "373927357726",
  appId: "1:373927357726:web:2a155c5ca9ee7066a62d0f",
  measurementId: "G-CFQC07GBVE"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth();

/* ---------- App State ---------- */
let data = [];
const PER_PAGE = 10;
let page = 1;
let importedFileNames = [];
let pendingDeleteIndex = null;
let currentUser = null;

/* ---------- DOM Elements ---------- */
const loginContainer = document.getElementById('login-container');
const mainContainer = document.getElementById('main-container');
const loginErrorEl = document.getElementById('loginError');

/* ---------- UI helpers ---------- */
function copyWithIcon(text, btnEl) {
  navigator.clipboard.writeText(text).then(()=>{ const icon = btnEl.querySelector('i'); const oldClass = icon.className; icon.className = 'fa fa-check'; setTimeout(()=>{ icon.className = oldClass; }, 1200); }).catch(()=>{});
}

function render(){
  document.getElementById('infoLine').textContent = `Tổng link hiện có: ${data.length}`;
  const q = (document.getElementById('searchInput').value||"").toLowerCase();
  
  const filtered = data.filter(d => 
      (d.short||'').toLowerCase().includes(q) || 
      (d.original||'').toLowerCase().includes(q) ||
      (d.title||'').toLowerCase().includes(q)
  );

  const totalPg = Math.max(1, Math.ceil(filtered.length / PER_PAGE));
  if(page>totalPg) page = totalPg;
  const start = (page-1)*PER_PAGE;
  const pageItems = filtered.slice(start, start+PER_PAGE);

  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = "";
  pageItems.forEach((item, idx)=>{
    const realIndex = start + idx;
    const tr = document.createElement('tr');

    // --- Ô rút gọn ---
    const tdShort = document.createElement('td');
    const shortWrapper = document.createElement('div');
    shortWrapper.className = 'cell-content-wrapper';
    
    const copyBtnShort = document.createElement('button');
    copyBtnShort.className = 'copy-btn';
    copyBtnShort.title = 'Copy full short URL';
    copyBtnShort.innerHTML = '<i class="fa fa-copy"></i>';
    copyBtnShort.onclick = ()=> copyWithIcon(location.origin + '/' + item.short, copyBtnShort);
    
    const shortLink = document.createElement('a');
    shortLink.href = location.origin + '/' + item.short;
    shortLink.target = '_blank';
    shortLink.className = 'link-text link-short';
    shortLink.textContent = item.short;
    
    shortWrapper.appendChild(copyBtnShort);
    shortWrapper.appendChild(shortLink);
    tdShort.appendChild(shortWrapper);

    // --- Ô Tiêu đề ---
    const tdTitle = document.createElement('td');
    tdTitle.textContent = item.title || '';
    tdTitle.className = 'title-text';
    tdTitle.title = item.title || '';

    // --- Ô link gốc ---
    const tdOrig = document.createElement('td');
    const origWrapper = document.createElement('div');
    origWrapper.className = 'cell-content-wrapper';

    const copyBtnOrig = document.createElement('button');
    copyBtnOrig.className = 'copy-btn';
    copyBtnOrig.title = 'Copy original URL';
    copyBtnOrig.innerHTML = '<i class="fa fa-copy"></i>';
    copyBtnOrig.onclick = ()=> copyWithIcon(item.original, copyBtnOrig);

    const origLink = document.createElement('a');
    origLink.href = item.original;
    origLink.target = 'blank';
    origLink.className = 'link-text';
    origLink.textContent = item.original;
    origLink.title = item.original;

    origWrapper.appendChild(copyBtnOrig);
    origWrapper.appendChild(origLink);
    tdOrig.appendChild(origWrapper);

    // --- Ô hành động ---
    const tdAct = document.createElement('td');
    tdAct.style.textAlign = 'right';

    const editBtn = document.createElement('button');
    editBtn.className = 'action-btn action-edit';
    editBtn.title = 'Sửa';
    editBtn.innerHTML = '<i class="fa fa-edit"></i>';
    editBtn.onclick = ()=> startEdit(realIndex, tr);
    editBtn.style.marginRight = '8px';

    const delBtn = document.createElement('button');
    delBtn.className = 'action-btn action-del';
    delBtn.title = 'Xóa';
    delBtn.innerHTML = '<i class="fa fa-trash"></i>';
    delBtn.onclick = ()=> showConfirm(realIndex);

    tdAct.appendChild(editBtn);
    tdAct.appendChild(delBtn);

    tr.appendChild(tdShort);
    tr.appendChild(tdTitle);
    tr.appendChild(tdOrig);
    tr.appendChild(tdAct);
    tbody.appendChild(tr);
  });

  const pgWrap = document.getElementById('pagination');
  pgWrap.innerHTML = "";
  for(let p=1;p<=totalPg;p++){
    const b = document.createElement('button');
    b.className = 'pg-btn' + (p===page? ' active' : '');
    b.textContent = p;
    b.onclick = ()=> { page = p; render(); };
    pgWrap.appendChild(b);
  }

  document.getElementById('dataTextarea').value = JSON.stringify(data, null, 2);
}

function startEdit(i, rowEl){
  const item = data[i];
  
  const tdShort = document.createElement('td');
  const shortInput = document.createElement('input');
  shortInput.className = 'table-edit-input';
  shortInput.value = item.short;
  tdShort.appendChild(shortInput);

  const tdTitle = document.createElement('td');
  const titleInput = document.createElement('input');
  titleInput.className = 'table-edit-input';
  titleInput.value = item.title || '';
  tdTitle.appendChild(titleInput);
  
  const tdOrig = document.createElement('td');
  const origInput = document.createElement('input');
  origInput.className = 'table-edit-input';
  origInput.value = item.original;
  tdOrig.appendChild(origInput);

  const tdAct = document.createElement('td');
  tdAct.style.textAlign = 'right';

  const saveBtn = document.createElement('button');
  saveBtn.className = 'action-btn action-save';
  saveBtn.title = 'Lưu';
  saveBtn.innerHTML = '<i class="fa fa-check"></i>';
  saveBtn.style.marginRight = '8px';
  saveBtn.onclick = async ()=> {
    const ns = shortInput.value.trim();
    const no = origInput.value.trim();
    const nt = titleInput.value.trim();
    if(!ns || !no) return;
    const oldShort = item.short;

    const payload = { original: no, title: nt };

    try {
      if (ns !== oldShort) {
        const existing = await getDoc(doc(db, "links", ns));
        if (existing.exists()) {
          return alert("Mã rút gọn mới đã tồn tại. Chọn mã khác.");
        }
        await setDoc(doc(db, "links", ns), payload);
        await deleteDoc(doc(db, "links", oldShort));
        data[i] = { short: ns, original: no, title: nt };
      } else {
        await updateDoc(doc(db, "links", ns), payload);
        data[i].original = no;
        data[i].title = nt;
      }
      render();
    } catch (err) {
      console.error(err);
      alert("Lỗi khi lưu: " + err.message);
      render();
    }
  };

  const cancelBtn = document.createElement('button');
  cancelBtn.className = 'action-btn action-del';
  cancelBtn.title = 'Hủy';
  cancelBtn.innerHTML = '<i class="fa fa-times"></i>';
  cancelBtn.onclick = ()=> render();

  tdAct.appendChild(saveBtn);
  tdAct.appendChild(cancelBtn);

  rowEl.innerHTML = '';
  rowEl.appendChild(tdShort);
  rowEl.appendChild(tdTitle);
  rowEl.appendChild(tdOrig);
  rowEl.appendChild(tdAct);
  shortInput.focus();
}

async function createNew(){
  if (!currentUser) return alert("Vui lòng đăng nhập admin để tạo link.");

  const orig = document.getElementById('originalInput').value.trim();
  const customAlias = document.getElementById('customAliasInput').value.trim();
  const title = document.getElementById('titleInput').value.trim();
  
  if (!orig) {
      alert("Vui lòng nhập link gốc.");
      return;
  }

  const createBtn = document.getElementById('createBtn');
  createBtn.disabled = true;

  let code = customAlias;

  if (code) {
    if (!/^[a-zA-Z0-9_-]+$/.test(code)) {
        alert("Mã tùy chỉnh chỉ được chứa chữ cái (a-z, A-Z), số (0-9), dấu gạch ngang (-) và gạch dưới (_).");
        createBtn.disabled = false;
        return;
    }
    const snap = await getDoc(doc(db, "links", code));
    if (snap.exists()) {
      alert("Mã rút gọn này đã tồn tại. Vui lòng chọn mã khác.");
      createBtn.disabled = false;
      return;
    }
  } 
  else {
    let codeFound = false;
    for (let length = 3; length <= 8; length++) {
        let tries = 0;
        const maxTriesPerLength = 15; 
        do {
            code = genCode(length);
            const snap = await getDoc(doc(db, "links", code));
            if (!snap.exists()) {
                codeFound = true;
                break;
            }
            tries++;
        } while (tries < maxTriesPerLength);

        if (codeFound) {
            break;
        }
    }

    if (!codeFound) {
        alert("Không thể tạo mã ngẫu nhiên duy nhất sau khi đã thử độ dài từ 3 đến 8. Vui lòng thử lại.");
        createBtn.disabled = false;
        return;
    }
  }
  try {
    const payload = { original: orig };
    if (title) {
        payload.title = title;
    }
    await setDoc(doc(db, "links", code), payload);
    
    const newUrl = `${location.origin}/${code}`;
    navigator.clipboard.writeText(newUrl).then(() => {
        const btnText = createBtn.querySelector('.btn-text');
        const originalText = btnText.textContent;
        const originalIcon = createBtn.querySelector('.btn-icon').outerHTML;

        btnText.textContent = 'Đã sao chép!';
        createBtn.querySelector('.btn-icon').outerHTML = '<i class="fa fa-check"></i>';
        
        setTimeout(() => {
          btnText.textContent = originalText;
          createBtn.querySelector('i').outerHTML = originalIcon;
          createBtn.disabled = false;
        }, 500);
    }).catch(err => {
        console.error('Failed to copy link: ', err);
        createBtn.disabled = false;
    });
    
    data.unshift({ short: code, original: orig, title: title }); 
    document.getElementById('originalInput').value = '';
    document.getElementById('customAliasInput').value = '';
    document.getElementById('titleInput').value = '';
    page = 1; 
    render();
  } catch (err) {
    console.error(err);
    alert("Lỗi tạo link: " + err.message);
    createBtn.disabled = false;
  }
}

function genCode(length = 8){
  const chars = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
  let out = "";
  for(let i=0; i<length; i++) { out += chars.charAt(Math.floor(Math.random() * chars.length)); }
  return out;
}
/* ---------- Export ---------- */
async function exportFile(){
  const MAX_FILE_BYTES = 5 * 1024 * 1024; // 5MB
  if (!data.length) {
    alert('Không có dữ liệu để xuất');
    return;
  }

  const filesToDownload = [];
  let temp = [];
  let partIdx = 1;

  for (const it of data) {
    temp.push(it);
    const blob = new Blob([JSON.stringify(temp, null, 2)], { type: 'application/json' });

    if (blob.size > MAX_FILE_BYTES) {
      temp.pop();
      if (temp.length) {
        filesToDownload.push({ name: `part${partIdx}.json`, content: JSON.stringify(temp, null, 2) });
        partIdx++;
      }
      temp = [it];
    }
  }

  if (temp.length) {
    filesToDownload.push({ name: `part${partIdx}.json`, content: JSON.stringify(temp, null, 2) });
  }

  for (const f of filesToDownload) {
    const blob = new Blob([f.content], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `data/${f.name}`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  if (importedFileNames.length) {
    document.getElementById('deleteCandidates').textContent = 'Gợi ý xóa (tên file đã nhập, nên xóa khỏi repo nếu đã gộp):\n' + importedFileNames.join('\n');
  }
  alert('Xuất xong. Tải các file trong thư mục data/ rồi upload lên GitHub (ghi đè nếu cần).');
}

function importSelectedFiles(files){
  if(!files || !files.length) return;
  importedFileNames = importedFileNames.concat(Array.from(files).map(f=>f.name));
  const readers = [];
  for(const f of files){
    readers.push(new Promise((res)=>{
      const r = new FileReader();
      r.onload = async (ev)=>{
        try{
          const arr = JSON.parse(ev.target.result);
          if(Array.isArray(arr)){
            const batch = writeBatch(db);
            arr.forEach(it=>{
              if(!it || !it.short) return;
              const id = String(it.short);
              const payload = {
                  original: String(it.original)
              };
              if (it.title) {
                  payload.title = String(it.title);
              }
              batch.set(doc(db, "links", id), payload);
            });
            await batch.commit();
          }
        }catch(e){}
        res();
      };
      r.readAsText(f);
    }));
  }
  Promise.all(readers).then(()=>{ page=1; loadLinks(); document.getElementById('fileName').textContent = `Đã nhập ${files.length} file`; document.getElementById('importedFilesList').textContent = 'Các file đã nhập: ' + importedFileNames.join(', '); });
}

function importFolderFiles(fileList){
  const jsonFiles = Array.from(fileList).filter(f=>f.name.endsWith('.json'));
  importSelectedFiles(jsonFiles);
}

document.getElementById('saveDataBtn').onclick = async function(){
  if (!currentUser) return alert("Vui lòng đăng nhập admin trước khi lưu dữ liệu!");
  try{
    const arr = JSON.parse(document.getElementById('dataTextarea').value);
    if(!Array.isArray(arr)) return alert('Dữ liệu không hợp lệ');

    const newMap = new Map();
    arr.forEach(it => { if(it && it.short) newMap.set(String(it.short), { original: String(it.original||""), title: String(it.title||"") }); });

    const snap = await getDocs(collection(db, "links"));
    const existingIds = new Set();
    snap.forEach(d => existingIds.add(d.id));

    const batch = writeBatch(db);
    for (const [short, value] of newMap.entries()) {
      const payload = { original: value.original };
      if (value.title) {
          payload.title = value.title;
      }
      batch.set(doc(db, "links", short), payload);
      existingIds.delete(short);
    }
    for (const id of existingIds) {
      batch.delete(doc(db, "links", id));
    }

    await batch.commit();
    await loadLinks();
    hideDataPopup();
    alert("Lưu dữ liệu vào Firestore thành công.");
  } catch(e){
    alert("Lỗi khi lưu dữ liệu: " + e.message);
  }
};


/* ---------- Confirm delete handlers ---------- */
function showConfirm(index) {
  pendingDeleteIndex = index;
  const popup = document.getElementById('confirmPopup');
  popup.style.display = 'flex';
  requestAnimationFrame(()=>{popup.classList.add('show');document.getElementById('confirmYes').focus();});
}
function hideConfirm(){
  const popup=document.getElementById('confirmPopup');
  popup.classList.remove('show');
  setTimeout(()=>popup.style.display='none',250);
  pendingDeleteIndex=null;
}
document.getElementById('confirmYes').onclick = async ()=> {
  if(pendingDeleteIndex !== null){
    const item = data[pendingDeleteIndex];
    try {
      await deleteDoc(doc(db, "links", item.short));
      data.splice(pendingDeleteIndex,1);
      render();
    } catch(e){ alert("Lỗi xóa: " + e.message); }
  }
  hideConfirm();
};
document.getElementById('confirmNo').onclick = hideConfirm;

/* ---------- Popup show/hide and copy ---------- */
function showDataPopup(){ const popup=document.getElementById('dataPopup'); popup.style.display='flex'; requestAnimationFrame(()=>popup.classList.add('show')); }
function hideDataPopup(){ const popup=document.getElementById('dataPopup'); popup.classList.remove('show'); setTimeout(()=>popup.style.display='none',250); }

document.getElementById('copyDataBtn').onclick = function(){ copyWithIcon(document.getElementById('dataTextarea').value, this); };
document.getElementById('showDataBtn').onclick = showDataPopup;
document.getElementById('closeDataPopup').onclick = hideDataPopup;

/* ---------- UI Event Listeners ---------- */
document.getElementById('createBtn').onclick = createNew;
document.getElementById('originalInput').addEventListener('keyup', (event) => {
    if (event.key === "Enter") {
        event.preventDefault();
    }
});
document.getElementById('searchInput').oninput = ()=>{ page=1; render(); };
document.getElementById('exportBtn').onclick = exportFile;
document.getElementById('importFiles').onchange = e=>{ importSelectedFiles(e.target.files); };
document.getElementById('importFolder').onchange = e=>{ importFolderFiles(e.target.files); };

const handleLoginOnEnter = (event) => {
    if (event.key === "Enter") {
        event.preventDefault();
        document.getElementById('loginBtn').click();
    }
};
document.getElementById('adminEmail').addEventListener('keyup', handleLoginOnEnter);
document.getElementById('adminPass').addEventListener('keyup', handleLoginOnEnter);


async function loadLinks(){
  try {
    const snapshot = await getDocs(collection(db, "links"));
    data = [];
    snapshot.forEach(docSnap => {
      const obj = docSnap.data();
      data.push({ 
        short: docSnap.id, 
        original: obj.original||"",
        title: obj.title||""
      });
    });
    data.sort((a,b)=>a.short.localeCompare(b.short));
    page = 1;
    render();
  } catch(err){
    console.error(err);
    alert("Lỗi khi load dữ liệu từ Firestore: " + err.message);
  }
}


/* ---------- AUTHENTICATION ---------- */
document.getElementById('loginBtn').onclick = async () => {
  const email = document.getElementById('adminEmail').value.trim();
  const pass = document.getElementById('adminPass').value.trim();
  loginErrorEl.textContent = '';
  if (!email || !pass) {
    loginErrorEl.textContent = "Vui lòng nhập email và mật khẩu.";
    return;
  }
  try {
    await signInWithEmailAndPassword(auth, email, pass);
  } catch(err) {
    loginErrorEl.textContent = "Đăng nhập thất bại. " + err.message;
  }
};

document.getElementById('logoutBtn').onclick = async () => {
  await signOut(auth);
};

onAuthStateChanged(auth, user => {
  currentUser = user;
  if (user) {
    loginContainer.style.display = 'none';
    mainContainer.style.display = 'block';
    document.getElementById('authStatus').textContent = `Đã đăng nhập: ${user.email}`;
    document.getElementById('domainPrefix').textContent = location.origin.replace(/https?:\/\//, '') + '/';
    loginErrorEl.textContent = '';
    loadLinks();
  } else {
    loginContainer.style.display = 'flex';
    mainContainer.style.display = 'none';
    data = [];
    render();
  }
});

</script>
</body>
</html>